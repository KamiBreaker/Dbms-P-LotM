{% extends "base.html" %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('reservations_start') }}">Step 1: Select User</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('reservations_areas', user_id=user_id) }}">Step 2: Select Area</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('reservations_lots', user_id=user_id, area_name=lot.area) }}">Step 3: Select Lot</a></li>
        <li class="breadcrumb-item active" aria-current="page">Step 4: Select Slot</li>
    </ol>
</nav>

<h1 class="mb-4">Select a Slot to Reserve in {{ lot.name }}</h1>
<p class="lead">Only available slots are clickable.</p>

<style>
    .slot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
    }
    .slot-btn {
        border: none;
        border-radius: 0.375rem;
        padding: 15px;
        text-align: center;
        font-weight: bold;
        color: white;
        width: 100%;
        height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .slot-btn .slot-type {
        font-size: 0.8rem;
        font-weight: normal;
    }
    .slot-btn:disabled {
        color: #ccc;
        cursor: not-allowed;
    }
</style>

<div class="legend">
    <div class="legend-item"><div class="legend-color status-available"></div><span>Available</span></div>
    <div class="legend-item"><div class="legend-color status-occupied"></div><span>Occupied</span></div>
    <div class="legend-item"><div class="legend-color status-reserved"></div><span>Reserved</span></div>
</div>

<form method="POST" action="{{ url_for('reservations_slots', user_id=user_id, lot_id=lot.id) }}" id="reservationForm">
    <div class="mb-3">
        <label for="vehicle_select" class="form-label">Select Vehicle</label>
        <select class="form-select" id="vehicle_select" name="license_plate_select" onchange="toggleLicensePlateInput()">
            <option value="">-- Select a Vehicle --</option>
            {% for vehicle in user_vehicles %}
                <option value="{{ vehicle.license_plate }}">{{ vehicle.license_plate }} ({{ vehicle.vehicle_type }})</option>
            {% endfor %}
            <option value="other">Other / New Vehicle</option>
        </select>
    </div>
    <div class="mb-3" id="manual_license_plate_div" style="display: none;">
        <label for="license_plate_manual" class="form-label">Enter License Plate</label>
        <input type="text" class="form-control" id="license_plate_manual" name="license_plate_manual" placeholder="e.g. ABC-123">
    </div>

    <div class="mb-3">
        <label for="expected_check_in_time" class="form-label">Expected Check-in Time</label>
        <input type="text" class="form-control flatpickr-datetime" id="expected_check_in_time" name="expected_check_in_time" placeholder="Select Check-in Date & Time" required>
    </div>
    <div class="mb-3">
        <label for="expected_check_out_time" class="form-label">Expected Check-out Time</label>
        <input type="text" class="form-control flatpickr-datetime" id="expected_check_out_time" name="expected_check_out_time" placeholder="Select Check-out Date & Time" required>
    </div>

    <div class="alert alert-info mt-3" id="price-estimation" style="display: none;">
        Estimated Upfront Payment: <strong><span id="estimated-cost">0.00</span> BDT</strong>
        <br><small class="text-muted">Rate: {{ lot.hourly_rate }} BDT/hr</small>
    </div>

    <div class="slot-grid">
        {% for slot in lot.slots|sort(attribute='slot_number') %}
            <button type="submit" name="slot_id" value="{{ slot.id }}" class="slot-btn status-{{ slot.status }}" {% if slot.status != 'available' %}disabled{% endif %}>
                <span>{{ slot.slot_number }}</span>
                <span class="slot-type">({{ slot.slot_type }})</span>
            </button>
        {% else %}
            <p>This parking lot has no slots configured.</p>
        {% endfor %}
    </div>
</form>

<script>
function toggleLicensePlateInput() {
    const select = document.getElementById('vehicle_select');
    const manualDiv = document.getElementById('manual_license_plate_div');
    if (select.value === 'other') {
        manualDiv.style.display = 'block';
        document.getElementById('license_plate_manual').required = true;
    } else {
        manualDiv.style.display = 'none';
        document.getElementById('license_plate_manual').required = false;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reservationForm');
    const hourlyRate = {{ lot.hourly_rate }};
    
    const checkInInput = document.getElementById('expected_check_in_time');
    const checkOutInput = document.getElementById('expected_check_out_time');
    const estimationDiv = document.getElementById('price-estimation');
    const costSpan = document.getElementById('estimated-cost');

    // Initialize Flatpickr
    flatpickr(".flatpickr-datetime", {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        minDate: "today",
        time_24hr: true
    });

    function updateEstimation() {
        const checkInStr = checkInInput.value;
        const checkOutStr = checkOutInput.value;

        if (checkInStr && checkOutStr) {
            const checkInDate = new Date(checkInStr);
            const checkOutDate = new Date(checkOutStr);

            let diffMs = checkOutDate - checkInDate;
            
            if (diffMs <= 0) {
               estimationDiv.style.display = 'none';
               return;
            }

            const diffHours = diffMs / (1000 * 60 * 60);
            let chargeableHours = Math.ceil(diffHours);
            if (chargeableHours < 1) chargeableHours = 1;

            const estimatedCost = chargeableHours * hourlyRate;
            
            costSpan.textContent = estimatedCost.toFixed(2);
            estimationDiv.style.display = 'block';
        } else {
            estimationDiv.style.display = 'none';
        }
    }

    checkInInput.addEventListener('change', updateEstimation);
    checkOutInput.addEventListener('change', updateEstimation);

    form.addEventListener('submit', function(event) {
        // Prevent default form submission for validation and custom handling
        event.preventDefault();

        const slotId = event.submitter.value; // Get slot_id from the clicked button
        
        // Handle License Plate
        const vehicleSelect = document.getElementById('vehicle_select');
        const manualInput = document.getElementById('license_plate_manual');
        let licensePlate = '';

        if (vehicleSelect.value === 'other') {
            licensePlate = manualInput.value;
        } else {
            licensePlate = vehicleSelect.value;
        }

        if (!licensePlate) {
            alert('Please select or enter a license plate.');
            return;
        }

        const checkInStr = document.getElementById('expected_check_in_time').value;
        const checkOutStr = document.getElementById('expected_check_out_time').value;

        if (!checkInStr || !checkOutStr) {
            alert('Please select both check-in and check-out times.');
            return;
        }

        const checkInDate = new Date(checkInStr);
        const checkOutDate = new Date(checkOutStr);

        // Client-side validation
        if (checkInDate >= checkOutDate) {
            alert('Expected Check-out Time must be after Expected Check-in Time.');
            return; 
        }

        // Create hidden input for slot_id
        const hiddenSlotId = document.createElement('input');
        hiddenSlotId.type = 'hidden';
        hiddenSlotId.name = 'slot_id';
        hiddenSlotId.value = slotId;
        form.appendChild(hiddenSlotId);
        
        // Create hidden input for license_plate
        const hiddenLicensePlate = document.createElement('input');
        hiddenLicensePlate.type = 'hidden';
        hiddenLicensePlate.name = 'license_plate';
        hiddenLicensePlate.value = licensePlate;
        form.appendChild(hiddenLicensePlate);

        // Submit the form
        form.submit();
    });
});
</script>

{% endblock %}
