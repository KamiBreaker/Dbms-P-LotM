{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">{{ lot.name }} - Visual Grid</h1>
<p class="lead">Area: {{ lot.area }}</p>

<style>
    .slot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 15px;
    }
    .slot {
        border: 1px solid #ccc;
        border-radius: 0.375rem;
        padding: 15px;
        text-align: center;
        font-weight: bold;
        color: white;
    }
    .slot .slot-type {
        font-size: 0.8rem;
        font-weight: normal;
        display: block;
    }
    .status-available {
        background-color: #28a745; /* Green */
    }
    .status-occupied {
        background-color: #dc3545; /* Red */
    }
    .status-reserved {
        background-color: #ffc107; /* Yellow */
        color: #212529;
    }
    .legend {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 0.25rem;
    }
</style>

<div class="legend">
    <div class="legend-item">
        <div class="legend-color status-available"></div>
        <span>Available</span>
    </div>
    <div class="legend-item">
        <div class="legend-color status-occupied"></div>
        <span>Occupied</span>
    </div>
    <div class="legend-item">
        <div class="legend-color status-reserved"></div>
        <span>Reserved</span>
    </div>
</div>

<div class="slot-grid">
    {% for slot in lot.slots|sort(attribute='slot_number') %}
        <div class="slot status-{{ slot.status }}">
            <span>{{ slot.slot_number }}</span>
            <span class="slot-type">({{ slot.slot_type }})</span>
            {% if slot.status == 'occupied' and slot.active_session %}
                <span class="slot-type" style="font-size: 0.7rem; margin-top: 5px;">
                    {{ slot.active_session.check_in_time.split('T')[1].split('.')[0][:5] }}
                </span>
            {% endif %}
            {% if g.user and g.user.role == 'admin' and slot.status != 'available' %}
                <button class="btn btn-sm btn-warning mt-2 make-available-btn" data-slot-id="{{ slot.id }}">Make Available</button>
            {% endif %}
        </div>
    {% else %}
        <p>This parking lot has no slots configured.</p>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const makeAvailableButtons = document.querySelectorAll('.make-available-btn');
    makeAvailableButtons.forEach(button => {
        button.addEventListener('click', function() {
            const slotId = this.dataset.slotId;
            const confirmAction = confirm('Are you sure you want to make this slot available? This will force check-out any active session and cancel any active reservation.');
            
            if (confirmAction) {
                fetch(`/slots/${slotId}/make-available`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer {{ session['access_token'] }}`
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Failed to update slot status.');
                })
                .then(data => {
                    alert(data.message || `Slot is now available.`);
                    location.reload(); // Reload page to reflect changes
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while making the slot available.');
                });
            }
        });
    });
});
</script>

{% if g.user and g.user.role == 'admin' %}
<div class="mt-5">
    <h2>Add New Slot</h2>
    <form action="{{ url_for('add_slot', lot_id=lot.id) }}" method="POST" class="row g-3">
        <div class="col-md-4">
            <label for="slot_number" class="form-label">Slot Number</label>
            <input type="text" class="form-control" id="slot_number" name="slot_number" required>
        </div>
        <div class="col-md-4">
            <label for="slot_type" class="form-label">Slot Type</label>
            <select class="form-select" id="slot_type" name="slot_type">
                <option value="regular">Regular</option>
                <option value="electric">Electric</option>
                <option value="handicap">Handicap</option>
            </select>
        </div>
        <div class="col-md-4 align-self-end">
            <button type="submit" class="btn btn-primary">Add Slot</button>
        </div>
    </form>
</div>
{% endif %}

{% endblock %}
